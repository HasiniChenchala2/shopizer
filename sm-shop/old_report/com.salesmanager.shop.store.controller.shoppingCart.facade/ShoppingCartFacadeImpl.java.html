<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShoppingCartFacadeImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sm-shop</a> &gt; <a href="index.source.html" class="el_package">com.salesmanager.shop.store.controller.shoppingCart.facade</a> &gt; <span class="el_source">ShoppingCartFacadeImpl.java</span></div><h1>ShoppingCartFacadeImpl.java</h1><pre class="source lang-java linenums">/**
 *
 */
package com.salesmanager.shop.store.controller.shoppingCart.facade;

import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

import javax.inject.Inject;
import javax.persistence.NoResultException;

import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.Validate;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.lang.Nullable;
import org.springframework.stereotype.Service;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import com.salesmanager.core.business.exception.ServiceException;
import com.salesmanager.core.business.services.catalog.pricing.PricingService;
import com.salesmanager.core.business.services.catalog.product.ProductService;
import com.salesmanager.core.business.services.catalog.product.attribute.ProductAttributeService;
import com.salesmanager.core.business.services.shoppingcart.ShoppingCartCalculationService;
import com.salesmanager.core.business.services.shoppingcart.ShoppingCartService;
//import com.salesmanager.core.business.utils.ProductPriceUtils;
import com.salesmanager.core.model.catalog.product.Product;
import com.salesmanager.core.model.catalog.product.attribute.ProductAttribute;
import com.salesmanager.core.model.catalog.product.availability.ProductAvailability;
import com.salesmanager.core.model.catalog.product.price.FinalPrice;
import com.salesmanager.core.model.catalog.product.variant.ProductVariant;
import com.salesmanager.core.model.customer.Customer;
import com.salesmanager.core.model.merchant.MerchantStore;
import com.salesmanager.core.model.reference.language.Language;
import com.salesmanager.core.model.shoppingcart.ShoppingCart;
import com.salesmanager.shop.constants.Constants;
import com.salesmanager.shop.mapper.cart.ReadableShoppingCartMapper;
import com.salesmanager.shop.model.shoppingcart.CartModificationException;
import com.salesmanager.shop.model.shoppingcart.PersistableShoppingCartItem;
import com.salesmanager.shop.model.shoppingcart.ReadableShoppingCart;
import com.salesmanager.shop.model.shoppingcart.ShoppingCartAttribute;
import com.salesmanager.shop.model.shoppingcart.ShoppingCartData;
import com.salesmanager.shop.model.shoppingcart.ShoppingCartItem;
import com.salesmanager.shop.populator.shoppingCart.ShoppingCartDataPopulator;
import com.salesmanager.shop.store.api.exception.ResourceNotFoundException;
import com.salesmanager.shop.store.api.exception.ServiceRuntimeException;
import com.salesmanager.shop.utils.DateUtil;
import com.salesmanager.shop.utils.ImageFilePath;

/**
 * @author Umesh Awasthi
 * @author Carl Samson
 * @version 3.2.0
 * @since 1.0
 */
@Service(value = &quot;shoppingCartFacade&quot;)
<span class="fc" id="L71">public class ShoppingCartFacadeImpl implements ShoppingCartFacade {</span>

<span class="fc" id="L73">	private static final Logger LOG = LoggerFactory.getLogger(ShoppingCartFacadeImpl.class);</span>

	@Inject
	private ShoppingCartService shoppingCartService;

	@Inject
	private ShoppingCartCalculationService shoppingCartCalculationService;


	@Inject
	private ProductService productService;

	@Inject
	private PricingService pricingService;

	@Inject
	private ProductAttributeService productAttributeService;

	@Inject
	@Qualifier(&quot;img&quot;)
	private ImageFilePath imageUtils;

	@Autowired
	private ReadableShoppingCartMapper readableShoppingCartMapper;

	public void deleteShoppingCart(final Long id, final MerchantStore store) throws Exception {
<span class="nc" id="L99">		ShoppingCart cart = shoppingCartService.getById(id, store);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (cart != null) {</span>
<span class="nc" id="L101">			shoppingCartService.deleteCart(cart);</span>
		}
<span class="nc" id="L103">	}</span>

	@Override
	public void deleteShoppingCart(final String code, final MerchantStore store) throws Exception {
<span class="nc" id="L107">		ShoppingCart cart = shoppingCartService.getByCode(code, store);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (cart != null) {</span>
<span class="nc" id="L109">			shoppingCartService.deleteCart(cart);</span>
		}
<span class="nc" id="L111">	}</span>

	// @Override
	// REMOVE
	public ShoppingCartData addItemsToShoppingCart(final ShoppingCartData shoppingCartData, final ShoppingCartItem item,
			final MerchantStore store, final Language language, final Customer customer) throws Exception {

<span class="nc" id="L118">		ShoppingCart cartModel = null;</span>

		/**
		 * Sometimes a user logs in and a shopping cart is present in db
		 * (shoppingCartData but ui has no cookie with shopping cart code so the cart
		 * code will have to be added to the item in order to process add to cart
		 * normally
		 */
<span class="nc bnc" id="L126" title="All 4 branches missed.">		if (shoppingCartData != null &amp;&amp; StringUtils.isBlank(item.getCode())) {</span>
<span class="nc" id="L127">			item.setCode(shoppingCartData.getCode());</span>
		}

<span class="nc bnc" id="L130" title="All 2 branches missed.">		if (!StringUtils.isBlank(item.getCode())) {</span>
			// get it from the db
<span class="nc" id="L132">			cartModel = getShoppingCartModel(item.getCode(), store);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">			if (cartModel == null) {</span>
<span class="nc" id="L134">				cartModel = createCartModel(shoppingCartData.getCode(), store, customer);</span>
			}

		}

<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (cartModel == null) {</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">			final String shoppingCartCode = StringUtils.isNotBlank(shoppingCartData.getCode())</span>
<span class="nc" id="L142">					? shoppingCartData.getCode()</span>
<span class="nc" id="L143">					: null;</span>
<span class="nc" id="L144">			cartModel = createCartModel(shoppingCartCode, store, customer);</span>

		}
<span class="nc" id="L147">		com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem = createCartItem(cartModel, item,</span>
				store);

<span class="nc" id="L150">		boolean duplicateFound = false;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">		if (CollectionUtils.isEmpty(item.getShoppingCartAttributes())) {// increment quantity</span>
			// get duplicate item from the cart
<span class="nc" id="L153">			Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; cartModelItems = cartModel.getLineItems();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">			for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem cartItem : cartModelItems) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">				if (cartItem.getProduct().getId().longValue() == shoppingCartItem.getProduct().getId().longValue()) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">					if (CollectionUtils.isEmpty(cartItem.getAttributes())) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">						if (!duplicateFound) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">							if (!shoppingCartItem.isProductVirtual()) {</span>
<span class="nc" id="L159">								cartItem.setQuantity(cartItem.getQuantity() + shoppingCartItem.getQuantity());</span>
							}
<span class="nc" id="L161">							duplicateFound = true;</span>
<span class="nc" id="L162">							break;</span>
						}
					}
				}
<span class="nc" id="L166">			}</span>
		}

<span class="nc bnc" id="L169" title="All 2 branches missed.">		if (!duplicateFound) {</span>
<span class="nc" id="L170">			cartModel.getLineItems().add(shoppingCartItem);</span>
		}

		/** Update cart in database with line items **/
<span class="nc" id="L174">		shoppingCartService.saveOrUpdate(cartModel);</span>

		// refresh cart
<span class="nc" id="L177">		cartModel = shoppingCartService.getById(cartModel.getId(), store);</span>

<span class="nc" id="L179">		shoppingCartCalculationService.calculate(cartModel, store, language);</span>

<span class="nc" id="L181">		ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();</span>
<span class="nc" id="L182">		shoppingCartDataPopulator.setShoppingCartCalculationService(shoppingCartCalculationService);</span>
<span class="nc" id="L183">		shoppingCartDataPopulator.setPricingService(pricingService);</span>
<span class="nc" id="L184">		shoppingCartDataPopulator.setimageUtils(imageUtils);</span>

<span class="nc" id="L186">		return shoppingCartDataPopulator.populate(cartModel, store, language);</span>
	}

	private com.salesmanager.core.model.shoppingcart.ShoppingCartItem createCartItem(final ShoppingCart cartModel,
			final ShoppingCartItem shoppingCartItem, final MerchantStore store) throws Exception {

<span class="nc" id="L192">		Product product = productService.getBySku(shoppingCartItem.getSku(), store, store.getDefaultLanguage());</span>

<span class="nc bnc" id="L194" title="All 2 branches missed.">		if (product == null) {</span>
<span class="nc" id="L195">			throw new Exception(&quot;Item with sku &quot; + shoppingCartItem.getSku() + &quot; does not exist&quot;);</span>
		}

<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (product.getMerchantStore().getId().intValue() != store.getId().intValue()) {</span>
<span class="nc" id="L199">			throw new Exception(</span>
<span class="nc" id="L200">					&quot;Item with sku &quot; + shoppingCartItem.getSku() + &quot; does not belong to merchant &quot; + store.getId());</span>
		}

		/**
		 * Check if product quantity is 0 Check if product is available Check if date
		 * available &lt;= now
		 */

<span class="nc" id="L208">		Set&lt;ProductAvailability&gt; availabilities = product.getAvailabilities();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (availabilities == null) {</span>

<span class="nc" id="L211">			throw new Exception(&quot;Item with id &quot; + product.getId() + &quot; is not properly configured&quot;);</span>

		}

<span class="nc bnc" id="L215" title="All 2 branches missed.">		for (ProductAvailability availability : availabilities) {</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">			if (availability.getProductQuantity() == null || availability.getProductQuantity().intValue() == 0) {</span>
<span class="nc" id="L217">				throw new Exception(&quot;Item with id &quot; + product.getId() + &quot; is not available&quot;);</span>
			}
<span class="nc" id="L219">		}</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (!product.isAvailable()) {</span>
<span class="nc" id="L222">			throw new Exception(&quot;Item with id &quot; + product.getId() + &quot; is not available&quot;);</span>
		}

<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (!DateUtil.dateBeforeEqualsDate(product.getDateAvailable(), new Date())) {</span>
<span class="nc" id="L226">			throw new Exception(&quot;Item with id &quot; + product.getId() + &quot; is not available&quot;);</span>
		}

<span class="nc" id="L229">		com.salesmanager.core.model.shoppingcart.ShoppingCartItem item = shoppingCartService</span>
<span class="nc" id="L230">				.populateShoppingCartItem(product, store);</span>

<span class="nc" id="L232">		item.setQuantity(shoppingCartItem.getQuantity());</span>
<span class="nc" id="L233">		item.setShoppingCart(cartModel);</span>

		// attributes
<span class="nc" id="L236">		List&lt;ShoppingCartAttribute&gt; cartAttributes = shoppingCartItem.getShoppingCartAttributes();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">		if (!CollectionUtils.isEmpty(cartAttributes)) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">			for (ShoppingCartAttribute attribute : cartAttributes) {</span>
<span class="nc" id="L239">				ProductAttribute productAttribute = productAttributeService.getById(attribute.getAttributeId());</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">				if (productAttribute != null</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">						&amp;&amp; productAttribute.getProduct().getId().longValue() == product.getId().longValue()) {</span>
<span class="nc" id="L242">					com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem attributeItem = new com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem(</span>
							item, productAttribute);

<span class="nc" id="L245">					item.addAttributes(attributeItem);</span>
				}
<span class="nc" id="L247">			}</span>
		}
<span class="nc" id="L249">		return item;</span>

	}

	// KEEP -- ENTRY
	private com.salesmanager.core.model.shoppingcart.ShoppingCartItem createCartItem(ShoppingCart cartModel,
			PersistableShoppingCartItem shoppingCartItem, MerchantStore store) throws Exception {

		// USE Product sku
<span class="fc" id="L258">		Product product = null;</span>

<span class="fc" id="L260">		product = productService.getBySku(shoppingCartItem.getProduct(), store, store.getDefaultLanguage());// todo use</span>
																											// language
																											// from api
																											// request
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">		if (product == null) {</span>
<span class="nc" id="L265">			throw new ResourceNotFoundException(</span>
<span class="nc" id="L266">					&quot;Product with sku &quot; + shoppingCartItem.getProduct() + &quot; does not exist&quot;);</span>
		}

<span class="pc bpc" id="L269" title="1 of 2 branches missed.">		if (product.getMerchantStore().getId().intValue() != store.getId().intValue()) {</span>
<span class="nc" id="L270">			throw new ResourceNotFoundException(</span>
<span class="nc" id="L271">					&quot;Item with id &quot; + shoppingCartItem.getProduct() + &quot; does not belong to merchant &quot; + store.getId());</span>
		}

<span class="pc bpc" id="L274" title="1 of 2 branches missed.">		if (!product.isAvailable()) {</span>
<span class="nc" id="L275">			throw new Exception(&quot;Product with sku &quot; + product.getSku() + &quot; is not available&quot;);</span>
		}

<span class="pc bpc" id="L278" title="1 of 2 branches missed.">		if (!DateUtil.dateBeforeEqualsDate(product.getDateAvailable(), new Date())) {</span>
<span class="nc" id="L279">			throw new Exception(&quot;Item with sku &quot; + product.getSku() + &quot; is not available&quot;);</span>
		}

<span class="fc" id="L282">		Set&lt;ProductAvailability&gt; availabilities = product.getAvailabilities();</span>

<span class="fc" id="L284">		ProductVariant instance = null;</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">		if (CollectionUtils.isNotEmpty(product.getVariants())) {</span>
<span class="nc" id="L286">			instance = product.getVariants().iterator().next();</span>
<span class="nc" id="L287">			Set&lt;ProductAvailability&gt; instanceAvailabilities = instance.getAvailabilities();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">			if(!CollectionUtils.isEmpty(instanceAvailabilities)) {</span>
<span class="nc" id="L289">				availabilities = instanceAvailabilities;</span>
			}
			
		}

<span class="pc bpc" id="L294" title="1 of 2 branches missed.">		if (CollectionUtils.isEmpty(availabilities)) {</span>
<span class="nc" id="L295">			throw new Exception(</span>
<span class="nc" id="L296">					&quot;Item with id &quot; + product.getId() + &quot; is not properly configured. It contains no inventory&quot;);</span>
		}

		//todo filter sku and store
<span class="fc bfc" id="L300" title="All 2 branches covered.">		for (ProductAvailability availability : availabilities) {</span>
<span class="pc bpc" id="L301" title="2 of 4 branches missed.">			if (availability.getProductQuantity() == null || availability.getProductQuantity().intValue() == 0) {</span>
<span class="nc" id="L302">				throw new Exception(&quot;Product with id &quot; + product.getId() + &quot; is not available&quot;);</span>
			}
<span class="fc" id="L304">		}</span>

		/**
		 * Check if product quantity is 0 Check if product is available Check if date
		 * available &lt;= now
		 */

		// use a mapper
<span class="fc" id="L312">		com.salesmanager.core.model.shoppingcart.ShoppingCartItem item = shoppingCartService</span>
<span class="fc" id="L313">				.populateShoppingCartItem(product, store);</span>

<span class="fc" id="L315">		item.setQuantity(shoppingCartItem.getQuantity());</span>
<span class="fc" id="L316">		item.setShoppingCart(cartModel);</span>
<span class="fc" id="L317">		item.setSku(product.getSku());</span>

<span class="pc bpc" id="L319" title="1 of 2 branches missed.">		if (instance != null) {</span>
<span class="nc" id="L320">			item.setVariant(instance.getId());</span>
		}

		// set attributes
<span class="fc" id="L324">		List&lt;com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute&gt; attributes = shoppingCartItem</span>
<span class="fc" id="L325">				.getAttributes();</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">		if (!CollectionUtils.isEmpty(attributes)) {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">			for (com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute attribute : attributes) {</span>

<span class="nc" id="L329">				ProductAttribute productAttribute = productAttributeService.getById(attribute.getId());</span>

<span class="nc bnc" id="L331" title="All 2 branches missed.">				if (productAttribute != null</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">						&amp;&amp; productAttribute.getProduct().getId().longValue() == product.getId().longValue()) {</span>

<span class="nc" id="L334">					com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem attributeItem = new com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem(</span>
							item, productAttribute);

<span class="nc" id="L337">					item.addAttributes(attributeItem);</span>
				}
<span class="nc" id="L339">			}</span>
		}

<span class="fc" id="L342">		return item;</span>
	}

	// used for api
	private List&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; createCartItems(ShoppingCart cartModel,
			List&lt;PersistableShoppingCartItem&gt; shoppingCartItems, MerchantStore store) throws Exception {

<span class="fc" id="L349">		List&lt;String&gt; productSkus = shoppingCartItems.stream().map(s -&gt; s.getProduct()).collect(Collectors.toList());</span>

<span class="fc" id="L351">		List&lt;Product&gt; products = productSkus.stream().map(p -&gt; this.fetchProduct(p, store, store.getDefaultLanguage()))</span>
<span class="fc" id="L352">				.collect(Collectors.toList());</span>

<span class="pc bpc" id="L354" title="2 of 4 branches missed.">		if (products == null || products.size() != shoppingCartItems.size()) {</span>
<span class="nc" id="L355">			LOG.warn(&quot;----------------------- Items with in id-list &quot; + productSkus + &quot; does not exist&quot;);</span>
<span class="nc" id="L356">			throw new ResourceNotFoundException(&quot;Item with skus &quot; + productSkus + &quot; does not exist&quot;);</span>
		}

<span class="pc bpc" id="L359" title="1 of 2 branches missed.">		List&lt;Product&gt; wrongStoreProducts = products.stream().filter(p -&gt; p.getMerchantStore().getId() != store.getId())</span>
<span class="fc" id="L360">				.collect(Collectors.toList());</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">		if (wrongStoreProducts.size() &gt; 0) {</span>
<span class="nc" id="L362">			throw new ResourceNotFoundException(&quot;One or more of the items with id's &quot;</span>
<span class="nc" id="L363">					+ wrongStoreProducts.stream().map(s -&gt; Long.valueOf(s.getId())).collect(Collectors.toList())</span>
<span class="nc" id="L364">					+ &quot; does not belong to merchant &quot; + store.getId());</span>
		}

<span class="fc" id="L367">		List&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; items = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L369" title="All 2 branches covered.">		for (Product p : products) {</span>
<span class="fc" id="L370">			com.salesmanager.core.model.shoppingcart.ShoppingCartItem item = shoppingCartService</span>
<span class="fc" id="L371">					.populateShoppingCartItem(p, store);</span>
<span class="fc" id="L372">			Optional&lt;PersistableShoppingCartItem&gt; oShoppingCartItem = shoppingCartItems.stream()</span>
<span class="fc" id="L373">					.filter(i -&gt; i.getProduct().equals(p.getSku())).findFirst();</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">			if (!oShoppingCartItem.isPresent()) {</span>
				// Should never happen if not something is updated in realtime or user has item
				// in local storage and add it long time after to cart!
<span class="nc" id="L377">				LOG.warn(&quot;Missing shoppingCartItem for product &quot; + p.getSku() + &quot; ( &quot; + p.getId() + &quot; )&quot;);</span>
<span class="nc" id="L378">				continue;</span>
			}
<span class="fc" id="L380">			PersistableShoppingCartItem shoppingCartItem = oShoppingCartItem.get();</span>
<span class="fc" id="L381">			item.setQuantity(shoppingCartItem.getQuantity());</span>
<span class="fc" id="L382">			item.setShoppingCart(cartModel);</span>

			/**
			 * Check if product is available Check if product quantity is 0 Check if date
			 * available &lt;= now
			 */
<span class="pc bpc" id="L388" title="1 of 4 branches missed.">			if (shoppingCartItem.getQuantity() &gt; 0 &amp;&amp; !p.isAvailable()) {</span>
<span class="nc" id="L389">				throw new Exception(&quot;Item with id &quot; + p.getId() + &quot; is not available&quot;);</span>
			}

<span class="fc" id="L392">			Set&lt;ProductAvailability&gt; availabilities = p.getAvailabilities();</span>
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">			if (availabilities == null) {</span>
<span class="nc" id="L394">				throw new Exception(&quot;Item with id &quot; + p.getId() + &quot; is not properly configured&quot;);</span>
			}

<span class="fc bfc" id="L397" title="All 2 branches covered.">			for (ProductAvailability availability : availabilities) {</span>
<span class="pc bpc" id="L398" title="2 of 6 branches missed.">				if (shoppingCartItem.getQuantity() &gt; 0 &amp;&amp; availability.getProductQuantity() == null || availability.getProductQuantity().intValue() == 0) {</span>
<span class="nc" id="L399">					throw new Exception(&quot;Item with id &quot; + p.getId() + &quot; is not available&quot;);</span>
				}
<span class="fc" id="L401">			}</span>

<span class="pc bpc" id="L403" title="1 of 2 branches missed.">			if (!DateUtil.dateBeforeEqualsDate(p.getDateAvailable(), new Date())) {</span>
<span class="nc" id="L404">				throw new Exception(&quot;Item with id &quot; + p.getId() + &quot; is not available&quot;);</span>
			}
			// end qty &amp; availablility checks

			// set attributes
<span class="fc" id="L409">			List&lt;com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute&gt; attributes = shoppingCartItem</span>
<span class="fc" id="L410">					.getAttributes();</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">			if (!CollectionUtils.isEmpty(attributes)) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">				for (com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute attribute : attributes) {</span>

<span class="nc" id="L414">					ProductAttribute productAttribute = productAttributeService.getById(attribute.getId());</span>

<span class="nc bnc" id="L416" title="All 2 branches missed.">					if (productAttribute != null</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">							&amp;&amp; productAttribute.getProduct().getId().longValue() == p.getId().longValue()) {</span>

<span class="nc" id="L419">						com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem attributeItem = new com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem(</span>
								item, productAttribute);

<span class="nc" id="L422">						item.addAttributes(attributeItem);</span>
					}
<span class="nc" id="L424">				}</span>
			}
<span class="fc" id="L426">			items.add(item);</span>
<span class="fc" id="L427">		}</span>

<span class="fc" id="L429">		return items;</span>
	}

	private Product fetchProduct(String sku, MerchantStore store, Language language) {
		try {
<span class="fc" id="L434">			return productService.getBySku(sku, store, language);</span>
<span class="nc" id="L435">		} catch (ServiceException e) {</span>
<span class="nc" id="L436">			throw new ServiceRuntimeException(e);</span>
		}
	}

	@Override
	public ShoppingCart createCartModel(final String shoppingCartCode, final MerchantStore store,
			final Customer customer) throws Exception {
<span class="nc bnc" id="L443" title="All 2 branches missed.">		final Long CustomerId = customer != null ? customer.getId() : null;</span>
<span class="nc" id="L444">		ShoppingCart cartModel = new ShoppingCart();</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">		if (StringUtils.isNotBlank(shoppingCartCode)) {</span>
<span class="nc" id="L446">			cartModel.setShoppingCartCode(shoppingCartCode);</span>
		} else {
<span class="nc" id="L448">			cartModel.setShoppingCartCode(uniqueShoppingCartCode());</span>
		}

<span class="nc" id="L451">		cartModel.setMerchantStore(store);</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">		if (CustomerId != null) {</span>
<span class="nc" id="L453">			cartModel.setCustomerId(CustomerId);</span>
		}
<span class="nc" id="L455">		shoppingCartService.create(cartModel);</span>
<span class="nc" id="L456">		return cartModel;</span>
	}

	private com.salesmanager.core.model.shoppingcart.ShoppingCartItem getEntryToUpdate(final long entryId,
			final ShoppingCart cartModel) {
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">		if (CollectionUtils.isNotEmpty(cartModel.getLineItems())) {</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">			for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cartModel</span>
<span class="fc" id="L463">					.getLineItems()) {</span>
<span class="pc bpc" id="L464" title="1 of 2 branches missed.">				if (shoppingCartItem.getId().longValue() == entryId) {</span>
<span class="fc" id="L465">					LOG.info(&quot;Found line item  for given entry id: &quot; + entryId);</span>
<span class="fc" id="L466">					return shoppingCartItem;</span>

				}
<span class="nc" id="L469">			}</span>
		}
<span class="nc" id="L471">		LOG.info(&quot;Unable to find any entry for given Id: &quot; + entryId);</span>
<span class="nc" id="L472">		return null;</span>
	}

	private Object getKeyValue(final String key) {
<span class="nc" id="L476">		ServletRequestAttributes reqAttr = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();</span>
<span class="nc" id="L477">		return reqAttr.getRequest().getAttribute(key);</span>
	}

	// @Override
	// DELETE
	public ShoppingCartData getShoppingCartData(final Customer customer, final MerchantStore store,
			final String shoppingCartId, Language language) throws Exception {

<span class="nc" id="L485">		ShoppingCart cart = null;</span>
		try {
<span class="nc bnc" id="L487" title="All 2 branches missed.">			if (customer != null) {</span>
<span class="nc" id="L488">				LOG.info(&quot;Reteriving customer shopping cart...&quot;);</span>
<span class="nc" id="L489">				cart = shoppingCartService.getShoppingCart(customer, store);</span>

			}

			else {
<span class="nc bnc" id="L494" title="All 4 branches missed.">				if (StringUtils.isNotBlank(shoppingCartId) &amp;&amp; cart == null) {</span>
<span class="nc" id="L495">					cart = shoppingCartService.getByCode(shoppingCartId, store);</span>
				}

			}

<span class="nc" id="L500">		} catch (ServiceException ex) {</span>
<span class="nc" id="L501">			LOG.error(&quot;Error while retriving cart from customer&quot;, ex);</span>
<span class="nc" id="L502">		} catch (NoResultException nre) {</span>
			// nothing
<span class="nc" id="L504">		}</span>

<span class="nc bnc" id="L506" title="All 2 branches missed.">		if (cart == null) {</span>
<span class="nc" id="L507">			return null;</span>
		}

		// if cart has been completed return null
<span class="nc bnc" id="L511" title="All 4 branches missed.">		if (cart.getOrderId() != null &amp;&amp; cart.getOrderId().longValue() &gt; 0) {</span>
<span class="nc bnc" id="L512" title="All 4 branches missed.">			if (StringUtils.isNotBlank(shoppingCartId) &amp;&amp; !(shoppingCartId.equals(cart.getShoppingCartCode()))) {</span>
<span class="nc" id="L513">				cart = shoppingCartService.getByCode(shoppingCartId, store);</span>
			} else {
<span class="nc" id="L515">				return null;</span>
			}
		}

<span class="nc" id="L519">		LOG.info(&quot;Cart model found.&quot;);</span>

<span class="nc" id="L521">		ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();</span>
<span class="nc" id="L522">		shoppingCartDataPopulator.setShoppingCartCalculationService(shoppingCartCalculationService);</span>
<span class="nc" id="L523">		shoppingCartDataPopulator.setPricingService(pricingService);</span>
<span class="nc" id="L524">		shoppingCartDataPopulator.setimageUtils(imageUtils);</span>

<span class="nc" id="L526">		MerchantStore merchantStore = (MerchantStore) getKeyValue(Constants.MERCHANT_STORE);</span>

<span class="nc" id="L528">		ShoppingCartData shoppingCartData = shoppingCartDataPopulator.populate(cart, merchantStore, language);</span>

<span class="nc" id="L530">		return shoppingCartData;</span>

	}

	// @Override
	public ShoppingCartData getShoppingCartData(ShoppingCart shoppingCartModel, Language language) throws Exception {

<span class="nc" id="L537">		Validate.notNull(shoppingCartModel, &quot;Shopping Cart cannot be null&quot;);</span>

<span class="nc" id="L539">		ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();</span>
<span class="nc" id="L540">		shoppingCartDataPopulator.setShoppingCartCalculationService(shoppingCartCalculationService);</span>
<span class="nc" id="L541">		shoppingCartDataPopulator.setPricingService(pricingService);</span>
<span class="nc" id="L542">		shoppingCartDataPopulator.setimageUtils(imageUtils);</span>
		// Language language = (Language) getKeyValue( Constants.LANGUAGE );
<span class="nc" id="L544">		MerchantStore merchantStore = (MerchantStore) getKeyValue(Constants.MERCHANT_STORE);</span>
<span class="nc" id="L545">		return shoppingCartDataPopulator.populate(shoppingCartModel, merchantStore, language);</span>
	}

	// @Override
	// DELETE
	public ShoppingCartData removeCartItem(final Long itemID, final String cartId, final MerchantStore store,
			final Language language) throws Exception {
<span class="nc bnc" id="L552" title="All 2 branches missed.">		if (StringUtils.isNotBlank(cartId)) {</span>

<span class="nc" id="L554">			ShoppingCart cartModel = getCartModel(cartId, store);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">			if (cartModel != null) {</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">				if (CollectionUtils.isNotEmpty(cartModel.getLineItems())) {</span>
<span class="nc" id="L557">					Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; shoppingCartItemSet = new HashSet&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt;();</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">					for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cartModel</span>
<span class="nc" id="L559">							.getLineItems()) {</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">						if (shoppingCartItem.getId().longValue() == itemID.longValue()) {</span>
<span class="nc" id="L561">							shoppingCartService.deleteShoppingCartItem(itemID);</span>
						} else {
<span class="nc" id="L563">							shoppingCartItemSet.add(shoppingCartItem);</span>
						}
<span class="nc" id="L565">					}</span>

<span class="nc" id="L567">					cartModel.setLineItems(shoppingCartItemSet);</span>

<span class="nc" id="L569">					ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();</span>
<span class="nc" id="L570">					shoppingCartDataPopulator.setShoppingCartCalculationService(shoppingCartCalculationService);</span>
<span class="nc" id="L571">					shoppingCartDataPopulator.setPricingService(pricingService);</span>
<span class="nc" id="L572">					shoppingCartDataPopulator.setimageUtils(imageUtils);</span>
<span class="nc" id="L573">					return shoppingCartDataPopulator.populate(cartModel, store, language);</span>

				}
			}
		}
<span class="nc" id="L578">		return null;</span>
	}

	// @Override
	// DELETE
	public ShoppingCartData updateCartItem(final Long itemID, final String cartId, final long newQuantity,
			final MerchantStore store, final Language language) throws Exception {
<span class="nc bnc" id="L585" title="All 2 branches missed.">		if (newQuantity &lt; 1) {</span>
<span class="nc" id="L586">			throw new CartModificationException(&quot;Quantity must not be less than one&quot;);</span>
		}
<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (StringUtils.isNotBlank(cartId)) {</span>
<span class="nc" id="L589">			ShoppingCart cartModel = getCartModel(cartId, store);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">			if (cartModel != null) {</span>
<span class="nc" id="L591">				com.salesmanager.core.model.shoppingcart.ShoppingCartItem entryToUpdate = getEntryToUpdate(</span>
<span class="nc" id="L592">						itemID.longValue(), cartModel);</span>

<span class="nc bnc" id="L594" title="All 2 branches missed.">				if (entryToUpdate == null) {</span>
<span class="nc" id="L595">					throw new CartModificationException(&quot;Unknown entry number.&quot;);</span>
				}

<span class="nc" id="L598">				entryToUpdate.getProduct();</span>

<span class="nc" id="L600">				LOG.info(&quot;Updating cart entry quantity to&quot; + newQuantity);</span>
<span class="nc" id="L601">				entryToUpdate.setQuantity((int) newQuantity);</span>
<span class="nc" id="L602">				List&lt;ProductAttribute&gt; productAttributes = new ArrayList&lt;ProductAttribute&gt;();</span>
<span class="nc" id="L603">				productAttributes.addAll(entryToUpdate.getProduct().getAttributes());</span>
<span class="nc" id="L604">				final FinalPrice finalPrice = pricingService.calculateProductPrice(entryToUpdate.getProduct(),</span>
						productAttributes);
<span class="nc" id="L606">				entryToUpdate.setItemPrice(finalPrice.getFinalPrice());</span>
<span class="nc" id="L607">				shoppingCartService.saveOrUpdate(cartModel);</span>

<span class="nc" id="L609">				LOG.info(&quot;Cart entry updated with desired quantity&quot;);</span>
<span class="nc" id="L610">				ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();</span>
<span class="nc" id="L611">				shoppingCartDataPopulator.setShoppingCartCalculationService(shoppingCartCalculationService);</span>
<span class="nc" id="L612">				shoppingCartDataPopulator.setPricingService(pricingService);</span>
<span class="nc" id="L613">				shoppingCartDataPopulator.setimageUtils(imageUtils);</span>
<span class="nc" id="L614">				return shoppingCartDataPopulator.populate(cartModel, store, language);</span>

			}
		}
<span class="nc" id="L618">		return null;</span>
	}

	// TODO promoCode request parameter
	// @Override
	// DELETE
	public ShoppingCartData updateCartItems(Optional&lt;String&gt; promoCode, final List&lt;ShoppingCartItem&gt; shoppingCartItems,
			final MerchantStore store, final Language language) throws Exception {

<span class="nc" id="L627">		Validate.notEmpty(shoppingCartItems, &quot;shoppingCartItems null or empty&quot;);</span>
<span class="nc" id="L628">		ShoppingCart cartModel = null;</span>
<span class="nc" id="L629">		Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; cartItems = new HashSet&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt;();</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">		for (ShoppingCartItem item : shoppingCartItems) {</span>

<span class="nc bnc" id="L632" title="All 2 branches missed.">			if (item.getQuantity() &lt; 1) {</span>
<span class="nc" id="L633">				throw new CartModificationException(&quot;Quantity must not be less than one&quot;);</span>
			}

<span class="nc bnc" id="L636" title="All 2 branches missed.">			if (cartModel == null) {</span>
<span class="nc" id="L637">				cartModel = getCartModel(item.getCode(), store);</span>
			}

<span class="nc" id="L640">			com.salesmanager.core.model.shoppingcart.ShoppingCartItem entryToUpdate = getEntryToUpdate(item.getId(),</span>
					cartModel);

<span class="nc bnc" id="L643" title="All 2 branches missed.">			if (entryToUpdate == null) {</span>
<span class="nc" id="L644">				throw new CartModificationException(&quot;Unknown entry number.&quot;);</span>
			}

<span class="nc" id="L647">			entryToUpdate.getProduct();</span>

<span class="nc" id="L649">			LOG.info(&quot;Updating cart entry quantity to&quot; + item.getQuantity());</span>
<span class="nc" id="L650">			entryToUpdate.setQuantity((int) item.getQuantity());</span>

<span class="nc" id="L652">			List&lt;ProductAttribute&gt; productAttributes = new ArrayList&lt;ProductAttribute&gt;();</span>
<span class="nc" id="L653">			productAttributes.addAll(entryToUpdate.getProduct().getAttributes());</span>

<span class="nc" id="L655">			final FinalPrice finalPrice = pricingService.calculateProductPrice(entryToUpdate.getProduct(),</span>
					productAttributes);
<span class="nc" id="L657">			entryToUpdate.setItemPrice(finalPrice.getFinalPrice());</span>

<span class="nc" id="L659">			cartItems.add(entryToUpdate);</span>

<span class="nc" id="L661">		}</span>

<span class="nc" id="L663">		cartModel.setPromoCode(null);</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">		if (promoCode.isPresent()) {</span>
<span class="nc" id="L665">			cartModel.setPromoCode(promoCode.get());</span>
<span class="nc" id="L666">			cartModel.setPromoAdded(new Date());</span>
		}

<span class="nc" id="L669">		cartModel.setLineItems(cartItems);</span>
<span class="nc" id="L670">		shoppingCartService.saveOrUpdate(cartModel);</span>

<span class="nc" id="L672">		LOG.info(&quot;Cart entry updated with desired quantity&quot;);</span>
<span class="nc" id="L673">		ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();</span>
<span class="nc" id="L674">		shoppingCartDataPopulator.setShoppingCartCalculationService(shoppingCartCalculationService);</span>
<span class="nc" id="L675">		shoppingCartDataPopulator.setPricingService(pricingService);</span>
<span class="nc" id="L676">		shoppingCartDataPopulator.setimageUtils(imageUtils);</span>
<span class="nc" id="L677">		return shoppingCartDataPopulator.populate(cartModel, store, language);</span>

	}

	private ShoppingCart getCartModel(final String cartId, final MerchantStore store) {
<span class="pc bpc" id="L682" title="1 of 2 branches missed.">		if (StringUtils.isNotBlank(cartId)) {</span>
			try {
<span class="fc" id="L684">				return shoppingCartService.getByCode(cartId, store);</span>
<span class="nc" id="L685">			} catch (ServiceException e) {</span>
<span class="nc" id="L686">				LOG.error(&quot;unable to find any cart asscoiated with this Id: &quot; + cartId);</span>
<span class="nc" id="L687">				LOG.error(&quot;error while fetching cart model...&quot;, e);</span>
<span class="nc" id="L688">				return null;</span>
<span class="nc" id="L689">			} catch (NoResultException nre) {</span>
				// nothing
			}

		}
<span class="nc" id="L694">		return null;</span>
	}

	// @Override
	// DELETE
	public ShoppingCartData getShoppingCartData(String code, MerchantStore store, Language language) {
		try {
<span class="nc" id="L701">			ShoppingCart cartModel = shoppingCartService.getByCode(code, store);</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">			if (cartModel != null) {</span>

<span class="nc" id="L704">				ShoppingCartData cart = getShoppingCartData(cartModel, language);</span>
<span class="nc" id="L705">				return cart;</span>
			}
<span class="nc" id="L707">		} catch (NoResultException nre) {</span>
			// nothing

<span class="nc" id="L710">		} catch (Exception e) {</span>
<span class="nc" id="L711">			LOG.error(&quot;Cannot retrieve cart code &quot; + code, e);</span>
<span class="nc" id="L712">		}</span>

<span class="nc" id="L714">		return null;</span>
	}

	@Override
	public ShoppingCart getShoppingCartModel(String shoppingCartCode, MerchantStore store) throws Exception {
<span class="nc" id="L719">		return shoppingCartService.getByCode(shoppingCartCode, store);</span>
	}

	@Override
	public ShoppingCart getShoppingCartModel(Customer customer, MerchantStore store) throws Exception {
<span class="nc" id="L724">		return shoppingCartService.getShoppingCart(customer, store);</span>
	}

	@Override
	public void saveOrUpdateShoppingCart(ShoppingCart cart) throws Exception {
<span class="nc" id="L729">		shoppingCartService.saveOrUpdate(cart);</span>

<span class="nc" id="L731">	}</span>

	@Override
	public ReadableShoppingCart getCart(Customer customer, MerchantStore store, Language language) throws Exception {

<span class="nc" id="L736">		Validate.notNull(customer, &quot;Customer cannot be null&quot;);</span>
<span class="nc" id="L737">		Validate.notNull(customer.getId(), &quot;Customer.id cannot be null or empty&quot;);</span>

		// Check if customer has an existing shopping cart
<span class="nc" id="L740">		ShoppingCart cartModel = shoppingCartService.getShoppingCart(customer, store);</span>

<span class="nc bnc" id="L742" title="All 2 branches missed.">		if (cartModel == null) {</span>
<span class="nc" id="L743">			return null;</span>
		}

<span class="nc" id="L746">		shoppingCartCalculationService.calculate(cartModel, store, language);</span>

<span class="nc" id="L748">		ReadableShoppingCart readableCart = new ReadableShoppingCart();</span>
<span class="nc" id="L749">		readableCart = readableShoppingCartMapper.convert(cartModel, store, language);</span>

<span class="nc" id="L751">		return readableCart;</span>
	}

	@Override
	// KEEP ** ENTRY POINT **
	public ReadableShoppingCart addToCart(PersistableShoppingCartItem item, MerchantStore store, Language language) {

<span class="fc" id="L758">		Validate.notNull(item, &quot;PersistableShoppingCartItem cannot be null&quot;);</span>

		// if cart does not exist create a new one

<span class="fc" id="L762">		ShoppingCart cartModel = new ShoppingCart();</span>
<span class="fc" id="L763">		cartModel.setMerchantStore(store);</span>
<span class="fc" id="L764">		cartModel.setShoppingCartCode(uniqueShoppingCartCode());</span>

<span class="pc bpc" id="L766" title="1 of 2 branches missed.">		if (!StringUtils.isBlank(item.getPromoCode())) {</span>
<span class="nc" id="L767">			cartModel.setPromoCode(item.getPromoCode());</span>
<span class="nc" id="L768">			cartModel.setPromoAdded(new Date());</span>
		}

		try {
<span class="fc" id="L772">			return readableShoppingCart(cartModel, item, store, language);</span>
<span class="nc" id="L773">		} catch (Exception e) {</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">			if (e instanceof ResourceNotFoundException) {</span>
<span class="nc" id="L775">				throw (ResourceNotFoundException) e;</span>
			} else {
<span class="nc" id="L777">				throw new ServiceRuntimeException(e.getMessage(),e);</span>
			}
		}
	}

	@Override
	// KEEP
	public @Nullable ReadableShoppingCart removeShoppingCartItem(String cartCode, String sku,
			MerchantStore merchant, Language language, boolean returnCart) throws Exception {
<span class="fc" id="L786">		Validate.notNull(cartCode, &quot;Shopping cart code must not be null&quot;);</span>
<span class="fc" id="L787">		Validate.notNull(sku, &quot;product sku must not be null&quot;);</span>
<span class="fc" id="L788">		Validate.notNull(merchant, &quot;MerchantStore must not be null&quot;);</span>

		// get cart
<span class="fc" id="L791">		ShoppingCart cart = getCartModel(cartCode, merchant);</span>

<span class="pc bpc" id="L793" title="1 of 2 branches missed.">		if (cart == null) {</span>
<span class="nc" id="L794">			throw new ResourceNotFoundException(&quot;Cart code [ &quot; + cartCode + &quot; ] not found&quot;);</span>
		}

<span class="fc" id="L797">		Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; items = new HashSet&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt;();</span>
<span class="fc" id="L798">		com.salesmanager.core.model.shoppingcart.ShoppingCartItem itemToDelete = null;</span>
<span class="fc bfc" id="L799" title="All 2 branches covered.">		for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cart.getLineItems()) {</span>
<span class="fc bfc" id="L800" title="All 2 branches covered.">			if (shoppingCartItem.getProduct().getSku().equals(sku)) {</span>
				// get cart item
<span class="fc" id="L802">				itemToDelete = getEntryToUpdate(shoppingCartItem.getId(), cart);</span>

				// break;

			} else {
<span class="fc" id="L807">				items.add(shoppingCartItem);</span>
			}
<span class="fc" id="L809">		}</span>
		// delete item
<span class="fc bfc" id="L811" title="All 2 branches covered.">		if (itemToDelete != null) {</span>
<span class="fc" id="L812">			shoppingCartService.deleteShoppingCartItem(itemToDelete.getId());</span>
		}

		// remaining items
<span class="fc bfc" id="L816" title="All 2 branches covered.">		if (items.size() &gt; 0) {</span>
<span class="fc" id="L817">			cart.setLineItems(items);</span>
		} else {
<span class="fc" id="L819">			cart.getLineItems().clear();</span>
		}

<span class="fc" id="L822">		shoppingCartService.saveOrUpdate(cart);// update cart with remaining items</span>
<span class="pc bpc" id="L823" title="1 of 4 branches missed.">		if (items.size() &gt; 0 &amp; returnCart) {</span>
<span class="nc" id="L824">			return this.getByCode(cartCode, merchant, language);</span>
		}
<span class="fc" id="L826">		return null;</span>
	}

	// KEEP
	private ReadableShoppingCart readableShoppingCart(ShoppingCart cartModel, PersistableShoppingCartItem item,
			MerchantStore store, Language language) throws Exception {

<span class="fc" id="L833">		com.salesmanager.core.model.shoppingcart.ShoppingCartItem itemModel = createCartItem(cartModel, item, store);</span>

		// need to check if the item is already in the cart
<span class="fc" id="L836">		boolean duplicateFound = false;</span>
		// only if item has no attributes
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">		if (CollectionUtils.isEmpty(item.getAttributes())) {// increment quantity</span>
			// get duplicate item from the cart
<span class="fc" id="L840">			Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; cartModelItems = cartModel.getLineItems();</span>
<span class="pc bpc" id="L841" title="1 of 2 branches missed.">			for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem cartItem : cartModelItems) {</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">				if (cartItem.getProduct().getSku().equals(item.getProduct())) {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">					if (CollectionUtils.isEmpty(cartItem.getAttributes())) {</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">						if (!duplicateFound) {</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">							if (!itemModel.isProductVirtual()) {</span>
<span class="nc" id="L846">								cartItem.setQuantity(cartItem.getQuantity() + item.getQuantity());</span>
							}
<span class="nc" id="L848">							duplicateFound = true;</span>
<span class="nc" id="L849">							break;</span>
						}
					}
				}
<span class="nc" id="L853">			}</span>
		}

<span class="pc bpc" id="L856" title="1 of 2 branches missed.">		if (!duplicateFound) {</span>
<span class="fc" id="L857">			cartModel.getLineItems().add(itemModel);</span>
		}

<span class="fc" id="L860">		saveShoppingCart(cartModel);</span>

		// refresh cart
<span class="fc" id="L863">		cartModel = shoppingCartService.getById(cartModel.getId(), store);</span>

<span class="fc" id="L865">		shoppingCartCalculationService.calculate(cartModel, store, language);</span>
<span class="fc" id="L866">		return readableShoppingCartMapper.convert(cartModel, store, language);</span>

	}

	@Override
	// KEEP
	public ReadableShoppingCart readableCart(ShoppingCart cart, MerchantStore store, Language language) {
<span class="nc" id="L873">		return readableShoppingCartMapper.convert(cart, store, language);</span>

	}

	private ReadableShoppingCart modifyCart(ShoppingCart cartModel, PersistableShoppingCartItem item,
			MerchantStore store, Language language) throws Exception {

<span class="fc" id="L880">		com.salesmanager.core.model.shoppingcart.ShoppingCartItem itemModel = createCartItem(cartModel, item, store);</span>

<span class="fc" id="L882">		boolean itemModified = false;</span>
		// check if existing product
<span class="fc" id="L884">		Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; items = cartModel.getLineItems();</span>
<span class="pc bpc" id="L885" title="1 of 2 branches missed.">		if (!CollectionUtils.isEmpty(items)) {</span>
<span class="fc" id="L886">			Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; newItems = new HashSet&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt;();</span>
<span class="fc" id="L887">			Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; removeItems = new HashSet&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt;();</span>
<span class="fc bfc" id="L888" title="All 2 branches covered.">			for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem anItem : items) {// take care of existing</span>
																							// product
<span class="pc bpc" id="L890" title="1 of 2 branches missed.">				if (itemModel.getProduct().getId().longValue() == anItem.getProduct().getId()) {</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">					if (item.getQuantity() == 0) {</span>
						// left aside item to be removed
						// don't add it to new list of item
<span class="nc" id="L894">						removeItems.add(anItem);</span>
					} else {
						// new quantity
<span class="nc" id="L897">						anItem.setQuantity(item.getQuantity());</span>
<span class="nc" id="L898">						newItems.add(anItem);</span>
					}
<span class="nc" id="L900">					itemModified = true;</span>
				} else {
<span class="fc" id="L902">					newItems.add(anItem);</span>
				}
<span class="fc" id="L904">			}</span>

<span class="pc bpc" id="L906" title="1 of 2 branches missed.">			if (!removeItems.isEmpty()) {</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">				for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem emptyItem : removeItems) {</span>
<span class="nc" id="L908">					shoppingCartService.deleteShoppingCartItem(emptyItem.getId());</span>
<span class="nc" id="L909">				}</span>

			}

<span class="pc bpc" id="L913" title="1 of 2 branches missed.">			if (!itemModified) {</span>
<span class="fc" id="L914">				newItems.add(itemModel);</span>
			}

<span class="pc bpc" id="L917" title="1 of 2 branches missed.">			if (newItems.isEmpty()) {</span>
<span class="nc" id="L918">				newItems = null;</span>
			}

<span class="fc" id="L921">			cartModel.setLineItems(newItems);</span>
<span class="fc" id="L922">		} else {</span>
			// new item
<span class="nc bnc" id="L924" title="All 2 branches missed.">			if (item.getQuantity() &gt; 0) {</span>
<span class="nc" id="L925">				cartModel.getLineItems().add(itemModel);</span>
			}
		}

		// if cart items are null just return cart with no items

		// promo code added to the cart but no promo cart exists
<span class="pc bpc" id="L932" title="3 of 4 branches missed.">		if (!StringUtils.isBlank(item.getPromoCode()) &amp;&amp; StringUtils.isBlank(cartModel.getPromoCode())) {</span>
<span class="nc" id="L933">			cartModel.setPromoCode(item.getPromoCode());</span>
<span class="nc" id="L934">			cartModel.setPromoAdded(new Date());</span>
		}

<span class="fc" id="L937">		saveShoppingCart(cartModel);</span>

		// refresh cart
<span class="fc" id="L940">		cartModel = shoppingCartService.getById(cartModel.getId(), store);</span>

<span class="pc bpc" id="L942" title="1 of 2 branches missed.">		if (cartModel == null) {</span>
<span class="nc" id="L943">			return null;</span>
		}

<span class="fc" id="L946">		shoppingCartCalculationService.calculate(cartModel, store, language);</span>

<span class="fc" id="L948">		ReadableShoppingCart readableCart = new ReadableShoppingCart();</span>
<span class="fc" id="L949">		readableCart = readableShoppingCartMapper.convert(cartModel, store, language);</span>

<span class="fc" id="L951">		return readableCart;</span>

	}

	/**
	 * Update cart based on the Items coming in with cartItems, Items not in
	 * incoming will not be affected, Items with Qty set to 0 will be removed from
	 * cart
	 *
	 * @param cartModel
	 * @param cartItems
	 * @param store
	 * @param language
	 * @return
	 * @throws Exception
	 */
	// KEEP
	private ReadableShoppingCart modifyCartMulti(ShoppingCart cartModel, List&lt;PersistableShoppingCartItem&gt; cartItems,
			MerchantStore store, Language language) throws Exception {

<span class="fc" id="L971">		int itemUpdatedCnt = 0;</span>
<span class="fc" id="L972">		List&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; inCartItemList = createCartItems(cartModel,</span>
				cartItems, store);

<span class="fc" id="L975">		Set&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; existingItems = cartModel.getLineItems();</span>
		// loop over incoming items since they drive changes
<span class="fc bfc" id="L977" title="All 2 branches covered.">		for (com.salesmanager.core.model.shoppingcart.ShoppingCartItem newItemValue : inCartItemList) {</span>

			// check that item exist in persisted cart
<span class="fc" id="L980">			Optional&lt;com.salesmanager.core.model.shoppingcart.ShoppingCartItem&gt; oOldItem = existingItems.stream()</span>
<span class="fc" id="L981">					.filter(i -&gt; i.getSku().equals(newItemValue.getSku())</span>

<span class="fc" id="L983">					).findFirst();</span>

<span class="pc bpc" id="L985" title="1 of 2 branches missed.">			if (oOldItem.isPresent()) {</span>
				// update of existing cartItem
<span class="fc" id="L987">				com.salesmanager.core.model.shoppingcart.ShoppingCartItem oldCartItem = oOldItem.get();</span>
<span class="pc bpc" id="L988" title="1 of 2 branches missed.">				if (oldCartItem.getQuantity().intValue() == newItemValue.getQuantity()) {</span>
					// this is unchanged
<span class="nc" id="L990">					continue;</span>
				}
<span class="fc bfc" id="L992" title="All 2 branches covered.">				if (newItemValue.getQuantity() == 0) {</span>
					// remove from cart
<span class="fc" id="L994">					shoppingCartService.deleteShoppingCartItem(oldCartItem.getId());</span>
<span class="fc" id="L995">					cartModel.getLineItems().remove(oldCartItem);</span>
<span class="fc" id="L996">					++itemUpdatedCnt;</span>
<span class="fc" id="L997">					continue;</span>
				}
				// update qty
<span class="fc" id="L1000">				oldCartItem.setQuantity(newItemValue.getQuantity());</span>
<span class="fc" id="L1001">				++itemUpdatedCnt;</span>
<span class="fc" id="L1002">			} else {</span>
				// addition of new item
<span class="nc" id="L1004">				cartModel.getLineItems().add(newItemValue);</span>
<span class="nc" id="L1005">				++itemUpdatedCnt;</span>
			}
<span class="fc" id="L1007">		}</span>
		// at the moment we expect that some change have been done
<span class="fc" id="L1009">		saveShoppingCart(cartModel);</span>

		// refresh cart
<span class="fc" id="L1012">		cartModel = shoppingCartService.getById(cartModel.getId(), store);</span>

<span class="pc bpc" id="L1014" title="1 of 2 branches missed.">		if (cartModel == null) {</span>
<span class="nc" id="L1015">			return null;</span>
		}

<span class="fc" id="L1018">		shoppingCartCalculationService.calculate(cartModel, store, language);</span>

<span class="fc" id="L1020">		return readableShoppingCartMapper.convert(cartModel, store, language);</span>

	}

	@Override
	// KEEP
	public ReadableShoppingCart addToCart(Customer customer, PersistableShoppingCartItem item, MerchantStore store,
			Language language) throws Exception {

<span class="nc" id="L1029">		Validate.notNull(customer, &quot;Customer cannot be null&quot;);</span>
<span class="nc" id="L1030">		Validate.notNull(customer.getId(), &quot;Customer.id cannot be null or empty&quot;);</span>

<span class="nc" id="L1032">		ShoppingCart cartModel = shoppingCartService.getShoppingCart(customer, store);</span>

		// if cart does not exist create a new one
<span class="nc bnc" id="L1035" title="All 2 branches missed.">		if (cartModel == null) {</span>
<span class="nc" id="L1036">			cartModel = new ShoppingCart();</span>
<span class="nc" id="L1037">			cartModel.setCustomerId(customer.getId());</span>
<span class="nc" id="L1038">			cartModel.setMerchantStore(store);</span>
<span class="nc" id="L1039">			cartModel.setShoppingCartCode(uniqueShoppingCartCode());</span>
		}

<span class="nc" id="L1042">		return readableShoppingCart(cartModel, item, store, language);</span>
	}

	@Override
	// KEEP
	public ReadableShoppingCart modifyCart(String cartCode, PersistableShoppingCartItem item, MerchantStore store,
			Language language) throws Exception {

<span class="fc" id="L1050">		Validate.notNull(cartCode, &quot;String cart code cannot be null&quot;);</span>
<span class="fc" id="L1051">		Validate.notNull(item, &quot;PersistableShoppingCartItem cannot be null&quot;);</span>

<span class="fc" id="L1053">		ShoppingCart cartModel = getCartModel(cartCode, store);</span>
<span class="fc bfc" id="L1054" title="All 2 branches covered.">		if (cartModel == null) {</span>
<span class="fc" id="L1055">			throw new ResourceNotFoundException(&quot;Cart code [&quot; + cartCode + &quot;] not found&quot;);</span>
		}

<span class="fc" id="L1058">		return modifyCart(cartModel, item, store, language);</span>
	}

	@Override
	// KEEP
	public ReadableShoppingCart modifyCartMulti(String cartCode, List&lt;PersistableShoppingCartItem&gt; items,
			MerchantStore store, Language language) throws Exception {
<span class="fc" id="L1065">		Validate.notNull(cartCode, &quot;String cart code cannot be null&quot;);</span>
<span class="fc" id="L1066">		Validate.notNull(items, &quot;PersistableShoppingCartItem cannot be null&quot;);</span>

<span class="fc" id="L1068">		ShoppingCart cartModel = this.getCartModel(cartCode, store);</span>
<span class="pc bpc" id="L1069" title="1 of 2 branches missed.">		if (cartModel == null) {</span>
<span class="nc" id="L1070">			throw new IllegalArgumentException(&quot;Cart code not valid&quot;);</span>
		}

<span class="fc" id="L1073">		return modifyCartMulti(cartModel, items, store, language);</span>
	}

	private void saveShoppingCart(ShoppingCart shoppingCart) throws Exception {
<span class="fc" id="L1077">		shoppingCartService.save(shoppingCart);</span>
<span class="fc" id="L1078">	}</span>

	private String uniqueShoppingCartCode() {
<span class="fc" id="L1081">		return UUID.randomUUID().toString().replaceAll(&quot;-&quot;, &quot;&quot;);</span>
	}

	@Override
	public ReadableShoppingCart getById(Long shoppingCartId, MerchantStore store, Language language) throws Exception {

<span class="nc" id="L1087">		ShoppingCart cart = shoppingCartService.getById(shoppingCartId);</span>

<span class="nc" id="L1089">		ReadableShoppingCart readableCart = null;</span>

<span class="nc bnc" id="L1091" title="All 2 branches missed.">		if (cart != null) {</span>

<span class="nc" id="L1093">			readableCart = readableShoppingCartMapper.convert(cart, store, language);</span>

		}

<span class="nc" id="L1097">		return readableCart;</span>
	}

	@Override
	public ShoppingCart getShoppingCartModel(Long id, MerchantStore store) throws Exception {
<span class="nc" id="L1102">		return shoppingCartService.getById(id);</span>
	}

	@Override
	// KEEP
	public ReadableShoppingCart getByCode(String code, MerchantStore store, Language language) throws Exception {

<span class="nc" id="L1109">		ShoppingCart cart = shoppingCartService.getByCode(code, store);</span>
<span class="nc" id="L1110">		ReadableShoppingCart readableCart = null;</span>

<span class="nc bnc" id="L1112" title="All 2 branches missed.">		if (cart != null) {</span>

<span class="nc" id="L1114">			readableCart = readableShoppingCartMapper.convert(cart, store, language);</span>

<span class="nc bnc" id="L1116" title="All 2 branches missed.">			if (!StringUtils.isBlank(cart.getPromoCode())) {</span>
<span class="nc" id="L1117">				Date promoDateAdded = cart.getPromoAdded();// promo valid 1 day</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">				if (promoDateAdded == null) {</span>
<span class="nc" id="L1119">					promoDateAdded = new Date();</span>
				}
<span class="nc" id="L1121">				Instant instant = promoDateAdded.toInstant();</span>
<span class="nc" id="L1122">				ZonedDateTime zdt = instant.atZone(ZoneId.systemDefault());</span>
<span class="nc" id="L1123">				LocalDate date = zdt.toLocalDate();</span>
				// date added &lt; date + 1 day
<span class="nc" id="L1125">				LocalDate tomorrow = LocalDate.now().plusDays(1);</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">				if (date.isBefore(tomorrow)) {</span>
<span class="nc" id="L1127">					readableCart.setPromoCode(cart.getPromoCode());</span>
				}
			}
		}

<span class="nc" id="L1132">		return readableCart;</span>

	}

	@Override
	public void setOrderId(String code, Long orderId, MerchantStore store) throws Exception {
<span class="nc" id="L1138">		ShoppingCart cart = this.getShoppingCartModel(code, store);</span>
<span class="nc bnc" id="L1139" title="All 2 branches missed.">		if (cart == null) {</span>
<span class="nc" id="L1140">			LOG.warn(&quot;Shopping cart with code [&quot; + code + &quot;] not found, expected to find a cart to set order id [&quot;</span>
					+ orderId + &quot;]&quot;);
		} else {
<span class="nc" id="L1143">			cart.setOrderId(orderId);</span>
		}
<span class="nc" id="L1145">		saveOrUpdateShoppingCart(cart);</span>

<span class="nc" id="L1147">	}</span>

	@Override
	public ReadableShoppingCart modifyCart(String cartCode, String promo, MerchantStore store, Language language)
			throws Exception {

<span class="nc" id="L1153">		ShoppingCart cart = shoppingCartService.getByCode(cartCode, store);</span>

<span class="nc" id="L1155">		cart.setPromoCode(promo);</span>
<span class="nc" id="L1156">		cart.setPromoAdded(new Date());</span>

<span class="nc" id="L1158">		shoppingCartService.save(cart);</span>

<span class="nc" id="L1160">		return readableShoppingCartMapper.convert(cart, store, language);</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>